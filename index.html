
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSv5b_zlYNBBvXg_VuGeXV5Mp0jqsNGSnpfG3lRVVMvXOAcsYA1PnhcKzbkKxkj-TU/exec';
const TIEMPO_PREGUNTA = 20;
const PREGUNTAS_POR_EQUIPO = 10; // Cada equipo responde 10 preguntas
const TOTAL_RONDAS = 10; // 10 rondas

let allQuestions = [];
let currentQuestionIndex = 0;
let currentTeamIndex = 0;
let teams = [];
let timer;
let timeLeft = TIEMPO_PREGUNTA;
let roundNumber = 1; // Contador de rondas

// Contador de preguntas por equipo
let questionCountPerTeam = {
    1: 0,
    2: 0,
    3: 0
};

// ===== CARGAR PREGUNTAS DESDE GOOGLE SHEETS =====
async function loadQuestions() {
    try {
        const response = await fetch(`${SCRIPT_URL}?action=getQuestions`);
        const questions = await response.json();
        
        if (questions && questions.length > 0) {
            allQuestions = questions;
            console.log(`‚úÖ Preguntas cargadas desde Sheets: ${allQuestions.length}`);
        } else {
            console.error('‚ùå No se recibieron preguntas');
            alert('Error: No se pudieron cargar las preguntas');
        }
    } catch (error) {
        console.error('‚ùå Error al cargar preguntas:', error);
        alert('Error de conexi√≥n con Google Sheets');
    }
}

// ===== INICIAR JUEGO =====
async function startGame() {
    const team1 = document.getElementById('team1-name').value.trim();
    const team2 = document.getElementById('team2-name').value.trim();
    const team3 = document.getElementById('team3-name').value.trim();
    const pass1 = document.getElementById('team1-pass').value.trim();
    const pass2 = document.getElementById('team2-pass').value.trim();
    const pass3 = document.getElementById('team3-pass').value.trim();

    if (!team1 || !team2 || !team3 || !pass1 || !pass2 || !pass3) {
        alert('Por favor completa todos los campos');
        return;
    }

    teams = [
        { name: team1, password: pass1, score: 0, teamNumber: 1 },
        { name: team2, password: pass2, score: 0, teamNumber: 2 },
        { name: team3, password: pass3, score: 0, teamNumber: 3 }
    ];

    // Resetear contadores
    questionCountPerTeam = { 1: 0, 2: 0, 3: 0 };
    roundNumber = 1;
    currentQuestionIndex = 0;
    currentTeamIndex = 0;

    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('loading-screen').classList.remove('hidden');

    await loadQuestions();

    if (allQuestions.length < 30) {
        alert('Error: No hay suficientes preguntas en Google Sheets');
        return;
    }

    document.getElementById('loading-screen').classList.add('hidden');
    showQuestion();
}

// ===== MOSTRAR PREGUNTA =====
function showQuestion() {
    // Verificar si termin√≥ el juego (cada equipo respondi√≥ 10 preguntas)
    if (questionCountPerTeam[1] >= PREGUNTAS_POR_EQUIPO && 
        questionCountPerTeam[2] >= PREGUNTAS_POR_EQUIPO && 
        questionCountPerTeam[3] >= PREGUNTAS_POR_EQUIPO) {
        
        console.log('üèÅ FIN DEL JUEGO - Cada equipo respondi√≥ 10 preguntas');
        endGame();
        return;
    }

    const currentTeam = teams[currentTeamIndex];
    const question = allQuestions[currentQuestionIndex];

    // Incrementar contador de preguntas del equipo actual
    questionCountPerTeam[currentTeam.teamNumber]++;

    console.log(`=== RONDA ${roundNumber} ===`);
    console.log(`Equipo ${currentTeam.teamNumber} (${currentTeam.name}): ${questionCountPerTeam[currentTeam.teamNumber]}/10 preguntas | Puntos: ${currentTeam.score}`);

    // Mostrar pantalla de pregunta
    document.getElementById('question-screen').classList.remove('hidden');
    document.getElementById('results-screen').classList.add('hidden');

    // Actualizar informaci√≥n
    document.getElementById('current-team').textContent = currentTeam.name;
    document.getElementById('team-color').className = `team-color team${currentTeam.teamNumber}`;
    document.getElementById('question-number').textContent = 
        `Pregunta ${questionCountPerTeam[currentTeam.teamNumber]} de ${PREGUNTAS_POR_EQUIPO}`;
    document.getElementById('question-text').textContent = question.pregunta;

    // Mostrar opciones
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = '';
    
    const options = [
        { text: question.opcion1, value: 'A' },
        { text: question.opcion2, value: 'B' },
        { text: question.opcion3, value: 'C' },
        { text: question.opcion4, value: 'D' }
    ];

    options.forEach(option => {
        const button = document.createElement('button');
        button.className = 'option-btn';
        button.innerHTML = `<span class="option-letter">${option.value}</span>${option.text}`;
        button.onclick = () => checkAnswer(option.value);
        optionsContainer.appendChild(button);
    });

    // Iniciar temporizador
    timeLeft = TIEMPO_PREGUNTA;
    updateTimer();
    timer = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
            clearInterval(timer);
            checkAnswer(null);
        }
    }, 1000);
}

// ===== ACTUALIZAR TEMPORIZADOR =====
function updateTimer() {
    const timerElement = document.getElementById('timer');
    timerElement.textContent = timeLeft;
    
    if (timeLeft <= 5) {
        timerElement.style.color = '#e74c3c';
        timerElement.style.animation = 'pulse 0.5s infinite';
    } else {
        timerElement.style.color = '#2c3e50';
        timerElement.style.animation = 'none';
    }
}

// ===== VERIFICAR RESPUESTA =====
function checkAnswer(selectedAnswer) {
    clearInterval(timer);
    
    const question = allQuestions[currentQuestionIndex];
    const currentTeam = teams[currentTeamIndex];
    const isCorrect = selectedAnswer === question.correcta;

    // Actualizar puntuaci√≥n
    if (isCorrect) {
        currentTeam.score += 10;
        console.log(`‚úÖ CORRECTO - ${currentTeam.name}: +10 puntos (Total: ${currentTeam.score})`);
    } else if (selectedAnswer === null) {
        console.log(`‚è∞ TIEMPO AGOTADO - ${currentTeam.name}`);
    } else {
        console.log(`‚ùå INCORRECTO - ${currentTeam.name}`);
    }

    // Mostrar resultado
    showResult(isCorrect, selectedAnswer === null, question);
}

// ===== MOSTRAR RESULTADO =====
function showResult(isCorrect, timeOut, question) {
    document.getElementById('question-screen').classList.add('hidden');
    document.getElementById('results-screen').classList.remove('hidden');

    const resultIcon = document.getElementById('result-icon');
    const resultText = document.getElementById('result-text');
    const explanationText = document.getElementById('explanation-text');

    if (timeOut) {
        resultIcon.textContent = '‚è∞';
        resultText.textContent = '¬°Tiempo agotado!';
        resultText.className = 'result-text timeout';
    } else if (isCorrect) {
        resultIcon.textContent = '‚úÖ';
        resultText.textContent = '¬°Correcto! +10 puntos';
        resultText.className = 'result-text correct';
    } else {
        resultIcon.textContent = '‚ùå';
        resultText.textContent = 'Incorrecto';
        resultText.className = 'result-text incorrect';
    }

    explanationText.textContent = `Respuesta correcta: ${question.correcta} - ${question.explicacion}`;

    // Actualizar ranking
    updateRanking();

    // Avanzar al siguiente equipo/pregunta despu√©s de 3 segundos
    setTimeout(() => {
        nextQuestion();
    }, 3000);
}

// ===== SIGUIENTE PREGUNTA =====
function nextQuestion() {
    currentQuestionIndex++;
    currentTeamIndex++;

    // Si termin√≥ la ronda (los 3 equipos jugaron)
    if (currentTeamIndex >= teams.length) {
        currentTeamIndex = 0;
        roundNumber++;
        console.log(`\nüîÑ NUEVA RONDA ${roundNumber}\n`);
    }

    // Verificar si el juego termin√≥
    if (questionCountPerTeam[1] >= PREGUNTAS_POR_EQUIPO && 
        questionCountPerTeam[2] >= PREGUNTAS_POR_EQUIPO && 
        questionCountPerTeam[3] >= PREGUNTAS_POR_EQUIPO) {
        
        console.log('üèÅ === FIN DE LAS 30 PREGUNTAS ===');
        endGame();
    } else {
        showQuestion();
    }
}

// ===== ACTUALIZAR RANKING =====
function updateRanking() {
    const sortedTeams = [...teams].sort((a, b) => b.score - a.score);
    
    sortedTeams.forEach((team, index) => {
        document.getElementById(`rank${index + 1}-name`).textContent = team.name;
        document.getElementById(`rank${index + 1}-score`).textContent = team.score;
    });
}

// ===== FINALIZAR JUEGO =====
function endGame() {
    document.getElementById('results-screen').classList.add('hidden');
    document.getElementById('final-screen').classList.remove('hidden');

    const sortedTeams = [...teams].sort((a, b) => b.score - a.score);

    // Verificar empates
    const maxScore = sortedTeams[0].score;
    const winners = sortedTeams.filter(team => team.score === maxScore);

    sortedTeams.forEach((team, index) => {
        document.getElementById(`final-rank${index + 1}-name`).textContent = team.name;
        document.getElementById(`final-rank${index + 1}-score`).textContent = team.score;
        
        const badge = document.getElementById(`final-rank${index + 1}-badge`);
        if (index === 0) {
            badge.textContent = winners.length > 1 ? 'üèÜ' : 'ü•á';
            document.getElementById(`final-rank${index + 1}-label`).textContent = 
                winners.length > 1 ? '¬°Empate!' : '¬°Campeones!';
        } else if (index === 1) {
            badge.textContent = 'ü•à';
        } else {
            badge.textContent = 'ü•â';
        }
    });

    console.log('üèÅ JUEGO TERMINADO');
    console.log('Resultados finales:');
    sortedTeams.forEach((team, i) => {
        console.log(`${i + 1}. ${team.name}: ${team.score} puntos (${questionCountPerTeam[team.teamNumber]} preguntas)`);
    });
}

// ===== NUEVA PARTIDA =====
function newGame() {
    location.reload();
}

// ===== INICIALIZAR =====
document.addEventListener('DOMContentLoaded', () => {
    console.log('üéÆ Juego de Etimolog√≠a Latina y Griega iniciado');
});
